<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>美约会-消费</title>
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link rel="stylesheet" type="text/css" href="../css/customer.css">
    <link rel="stylesheet" type="text/css" href="../css/buy.css">
</head>
<body>

<div id="app" class="customer">
    <p class="cus_title">
        <el-breadcrumb separator-class="el-icon-arrow-right">
            <el-breadcrumb-item><a href="home.html" target="iframe">工作台首页</a></el-breadcrumb-item>
            <el-breadcrumb-item><a href="customer.html" target="iframe">会员管理</a></el-breadcrumb-item>
            <el-breadcrumb-item>消费</el-breadcrumb-item>
        </el-breadcrumb>
    </p>
    <template>

        <el-tabs type="card" @tab-click="handleClick" class="vip_infor">
            <el-tab-pane label="产品">

            </el-tab-pane>
            <el-tab-pane label="项目">
            </el-tab-pane>
            <el-tab-pane label="套盒">

            </el-tab-pane>
            <el-tab-pane label="方案">

            </el-tab-pane>
            <el-tab-pane label="卡项">

            </el-tab-pane>

            <el-tab-pane label="内衣">

            </el-tab-pane>

            <el-tab-pane>
                <span slot="label" @click="recharge_dio=true;get_m_blance()"
                      style="display: inline-block;width: 100%;height:100%;cursor: pointer">充值</span>
            </el-tab-pane>
        </el-tabs>
        <div v-if="tabIndex!=6">
            <div class="cus_center">
                <el-input v-if="tabIndex!=5" style="margin:5px 0;" class="cus_seatch"
                          placeholder="请输入商品名称"
                          prefix-icon="el-icon-search"
                          v-model="input" @keyup.native="get_search()">
                </el-input>
                <el-input v-if="tabIndex==5" style="margin:5px 0;width: 350px" class="cus_seatch"
                          placeholder="请输入内衣名称或编号或尺码或罩杯搜索"
                          prefix-icon="el-icon-search"
                          v-model="input" @keyup.native="get_search()">
                </el-input>
            </div>
            <!--                !input || data.name.toLowerCase().includes(input.toLowerCase())) &&-->
            <div class="basic_inf">
                <el-table border :max-height="max_ht"
                          ref="multipleTable"
                          :data="list"
                          tooltip-effect="dark"
                          style="width: 100%">
                    <el-table-column :key="Math.random()" v-if="tabIndex==0||tabIndex==1||tabIndex==2||tabIndex==3"
                                     label="品项"
                                     width="120"
                                     prop="type">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==5"
                                     label="编号"
                                     prop="sn" min-width="140">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==5"
                                     label="类型">
                        <template slot-scope="scope">
                            <i v-if="scope.row.type==1">胸衣</i>
                            <i v-if="scope.row.type==2">其他</i>
                        </template>
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==0||tabIndex==1||tabIndex==2"
                                     prop="class"
                                     label="类别"
                                     width="120">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==4"
                                     label="卡项类型"
                                     width="120">
                        <template slot-scope="scope">
                            <i v-if="scope.row.card_type==3">全场折扣卡</i>
                            <i v-if="scope.row.card_type==2">折扣储值卡</i>
                            <i v-if="scope.row.card_type==1">储值卡</i>
                        </template>
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex!=4"
                                     prop="name"
                                     label="商品名称"
                                     min-width="210">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==4"
                                     prop="card_name"
                                     label="卡项名称"
                                     min-width="210">
                    </el-table-column>
                    <el-table-column v-if="tabIndex==4"
                                     prop="amount"
                                     label="余额">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==5"
                                     prop="color"
                                     label="颜色">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==5"
                                     prop="size"
                                     label="尺码">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==5"
                                     prop="cup"
                                     label="罩杯">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==5"
                                     prop="unit"
                                     label="单位">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex!=3"
                                     prop="price"
                                     label="零售价">
                    </el-table-column>
                    <el-table-column v-if="tabIndex==3"
                                     prop="sale"
                                     label="零售价">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==0||tabIndex==2"
                                     prop="stock"
                                     label="库存">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==5"
                                     prop="sum"
                                     label="数量">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==0||tabIndex==1||tabIndex==2"
                                     prop="beforehand_num"
                                     label="预售">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==1||tabIndex==2"
                                     prop="fre"
                                     label="次数">
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==2||tabIndex==3||tabIndex==1"
                                     label="可赠送">
                        <template slot-scope="scope">
                            <i v-if="scope.row.free==1">是</i>
                            <i v-if="scope.row.free==2">否</i>
                        </template>
                    </el-table-column>
                    <el-table-column :key="Math.random()" v-if="tabIndex==4"
                                     label="可赠送">
                        <template slot-scope="scope">
                            <i v-if="scope.row.send==1">是</i>
                            <i v-if="scope.row.send==2">否</i>
                        </template>
                    </el-table-column>
                    <el-table-column
                            label="加入购物车"
                            show-overflow-tooltip>
                        <template slot-scope="scope">
                            <i class="el-icon-remove blue_c" @click="remove(scope.row)" v-if="scope.row.needNum>0"></i>
                            <i v-if="scope.row.needNum>0">{{scope.row.needNum}}</i>
                            <i class="el-icon-circle-plus blue_c" @click="add(scope.row)"></i>
                        </template>
                    </el-table-column>
                </el-table>
                <div v-if="this.total>10" style="background: #fff;text-align: center;padding: 10px 0">
                    <el-pagination background
                                   @current-change="handleCurrentChange"
                                   :current-page="currentPage"
                                   :page-size="10"
                                   :page-sizes="[10]"
                                   layout="total,sizes, prev, pager, next, jumper"
                                   :total="total" :pager-count="8"
                                   @prev-click="prev_click" @next-click="next_click">
                    </el-pagination>
                </div>
            </div>
        </div>
        <!--<div v-if="need.length>0" style="height: 250px;"></div>-->
        <div v-if="need.length>0" class="cart_div" style="z-index: 10">
            <p class="cart_title">
                已选择（{{need.length}}）
                <span class="fr mar_hun cursor" @click="allRemove">
                <img src="../images/delete.png">&nbsp;全部清空
               </span>
            </p>
            <div style="height: 200px;background: white;overflow: scroll;">
                <ul class="consume_list" style="margin-bottom: 50px">
                    <li v-for="v in need" class="linr_four">
                        <span class="g_name">
                             {{v.name}}
                        </span><!--{{v.yh==1?v.price * v.discount/10*v.needNum:v.yh==2?0:v.price2}}-->
                        <span class="p_wid">￥{{v.yh==2?0:v.one*v.needNum}}</span>
                        <span>
                            优惠方式
                            <el-radio v-model="v.yh" label="1">打折</el-radio>
                            <el-input v-if="v.yh==1" v-model="v.discount" placeholder="0-10"
                                      class="in_wid und_line" type="number" v-on:input="getDis(v)"></el-input>
                            <el-radio v-model="v.yh" @change="v.discount=10" label="3">改价</el-radio>
                            <el-input v-if="v.yh==3" v-model="v.price2" placeholder="请输入价格"
                                      class="in_wid und_line" type="number" v-on:input="getPrice(v)"></el-input>
                            <el-radio v-model="v.yh" label="2">赠送</el-radio>
                            <template v-if="v.type=='项目'|| v.type=='方案'">
                                <i class="check_box">
                                    <!--<el-checkbox v-model="checked">修改次数</el-checkbox>-->
                                    修改次数
                                </i>
                                <el-input v-model="v.fre" placeholder="请输入次数" class="in_wid und_line"></el-input>
                            </template>
                        </span>
                        <span class="fr mar_hun">
                             <i class="el-icon-remove blue_c" @click="remove(v)"></i>
                             <i>{{v.needNum}}</i>
                             <i class="el-icon-circle-plus blue_c" @click="add(v)"></i>
                        </span>
                    </li>
                </ul>
            </div>
            <div class="cart_total">
                 <span class="fl cr total_money">
                     合计：{{total_price}}
                 </span>
                <span class="green pay cursor" @click="sub">提交订单</span>
            </div>
        </div>
        <!--充值弹窗-->
        <el-dialog
                title="充值"
                :visible.sync="recharge_dio"
                center
                :before-close="cancel">
            <ul class="goods_edit">
                <li>
                    <span class="list_left">选择</span>
                    <span class="list_right">
                        <span @click="get_m_blance()">
                            <el-radio v-model="rech_type" label="1">账户充值</el-radio>
                        </span>
                        <span @click="get_m_card()">
                            <el-radio v-model="rech_type" label="2">卡项充值</el-radio>
                        </span>
                    </span>
                </li>

                <li v-if="rech_type==1">
                    <div class="cus_center">
                        <el-button class="fr"
                                   size="mini"
                                   type="warning"
                                   @click="record_dio=true;get_record('balance')">充值记录
                        </el-button>
                    </div>
                    <ul class="goods_edit">
                        <li>
                            <span class="list_left">当前余额</span>
                            <span class="list_right">
                                {{acc_blance}}
                            </span>
                        </li>
                        <li>
                            <span class="list_left">充值金额</span>
                            <span class="list_right">
                                <el-input v-model="re_money" type="number" placeholder="请输入充值金额"></el-input>
                            </span>
                        </li>
                        <li>
                            <span class="list_left">赠送余额</span>
                            <span class="list_right">
                                <el-input v-model="send_money" type="number" placeholder="请输入赠送余额"></el-input>
                            </span>
                        </li>
                        <li>
                            <span class="list_left">支付方式</span>
                            <span class="list_right">
                                 <el-select v-model="ways" placeholder="请选择支付方式">
                                    <el-option
                                            v-for="item in options"
                                            :key="item.value"
                                            :label="item.label"
                                            :value="item.value">
                                    </el-option>
                                  </el-select>
                            </span>
                        </li>
                        <li>
                            <span class="list_left">赠送积分</span>
                            <span class="list_right">
                                <el-input v-model="integral" type="number" placeholder="请输入赠送积分"></el-input>
                            </span>
                        </li>
                    </ul>
                </li>
                <li v-if="rech_type==2">
                    <ul class="card_li">
                        <li v-if="card_lis.length==0">
                            您还没有购买卡项额！
                        </li>
                        <li v-for="v in card_lis">
                            <div>
                                <p>{{v.name}}</p>
                                <p>余额:{{v.amount}}&#12288;卡类:
                                    <i v-if="v.card_type==1">储值卡</i>
                                    <i v-if="v.card_type==2">普通折扣卡</i>
                                    <i v-if="v.card_type==1">储值卡</i>
                                </p>
                            </div>
                            <span>
                                <el-button
                                        size="mini"
                                        type="primary"
                                        @click="card_re_dio=true;ca_id=v.id;card_blance=v.amount">充值
                                </el-button>
                            </span>
                        </li>
                    </ul>
                </li>
            </ul>
            <div class="change_time" v-if="rech_type==1">
                <el-checkbox v-model="bulu" class="bulu_class" @change="bulu_state(bulu)">是否为补录</el-checkbox>
                <el-date-picker v-if="bulu==true" prefix-icon="el-icon-date"
                                value-format="yyyy-MM-dd HH:mm:ss"
                                v-model="supp_time"
                                type="datetime" @change="sub_o_time"
                                placeholder="选择补录日期" :picker-options="pickerOptions0">
                </el-date-picker>
            </div>
            <span slot="footer" class="dialog-footer" v-if="rech_type==1">
            <el-button @click="cancel">取 消</el-button>
            <el-button type="primary" @click="recha_blance()">确 定</el-button>
          </span>
        </el-dialog>
        <!--卡项充值内弹窗-->
        <el-dialog
                title="卡项充值" append-to-body
                :visible.sync="card_re_dio"
                center
                :before-close="cancel_in">
            <div class="cus_center">
                <el-button class="fr"
                           size="mini"
                           type="warning"
                           @click="record_dio=true;get_record('card')">充值记录
                </el-button>
            </div>
            <ul class="goods_edit">
                <li>
                    <span class="list_left">卡余额</span>
                    <span class="list_right">
                        {{card_blance}}
                    </span>
                </li>
                <li>
                    <span class="list_left">充值金额</span>
                    <span class="list_right">
                        <el-input v-model="card_money" type="number" placeholder="请输入充值金额"></el-input>
                    </span>
                </li>
                <li>
                    <span class="list_left">支付方式</span>
                    <span class="list_right">
                                 <el-select v-model="ways" placeholder="请选择支付方式">
                                    <el-option
                                            v-for="item in options"
                                            :key="item.value"
                                            :label="item.label"
                                            :value="item.value">
                                    </el-option>
                                  </el-select>
                            </span>
                </li>
                <li>
                    <span class="list_left">赠送积分</span>
                    <span class="list_right">
                                <el-input v-model="integral" type="number" placeholder="请输入赠送积分"></el-input>
                            </span>
                </li>
            </ul>
            <div class="change_time">
                <el-checkbox v-model="bulu" class="bulu_class" @change="bulu_state(bulu)">是否为补录</el-checkbox>
                <el-date-picker v-if="bulu==true" prefix-icon="el-icon-date"
                                value-format="yyyy-MM-dd HH:mm:ss"
                                v-model="supp_time"
                                type="datetime" @change="sub_o_time"
                                placeholder="选择补录日期" :picker-options="pickerOptions0">
                </el-date-picker>
            </div>
            <span slot="footer" class="dialog-footer">
            <el-button @click="cancel_in()">取 消</el-button>
            <el-button type="primary" @click="card_recha()">确 定</el-button>
          </span>
        </el-dialog>
        <!-- 卡项、账户充值记录 -->
        <el-dialog append-to-body
                   title="充值记录"
                   :visible.sync="record_dio"
                   center>
            <el-table border
                      :data="record"
                      style="width: 100%">
                <el-table-column
                        type="index"
                        width="50">
                </el-table-column>
                <el-table-column
                        label="类型">
                    <template slot-scope="scope">
                        <i v-if="scope.row.type==1">余额</i>
                        <i v-if="scope.row.type==2">卡项</i>
                    </template>
                </el-table-column>
                <el-table-column
                        prop="money"
                        label="金额">
                </el-table-column>
                <el-table-column
                        prop="send_money"
                        label="赠送金额">
                </el-table-column>
                <el-table-column
                        prop="time"
                        label="时间">
                </el-table-column>
            </el-table>
        </el-dialog>
    </template>

</div>

</body>
</html>
<script src="../js/jquery.min.js"></script>
<script src="../js/vue.js"></script>
<script src="../js/func.js"></script>
<script src="../js/index.js"></script>
<script>
    new Vue({
        el: '#app',
        data: {
            search_list: '',
            currentPage: 1,
            page: 1,
            page_count: '',
            total: 0,
            all_list: '',
            count: '',
            options: [{
                value: 1,
                label: '现金'
            }, {
                value: 2,
                label: '微信'
            }, {
                value: 3,
                label: '支付宝'
            }, {
                value: 4,
                label: '银行卡'
            }, {
                value: 5,
                label: '美团'
            }, {
                value: 6,
                label: '大众点评'
            }, {
                value: 7,
                label: '收钱吧'
            }],
            ways: 1,
            integral: '',
            pickerOptions0: {
                disabledDate(time) {
                    return time.getTime() > Date.now();
                }
            },
            bulu: false,
            supp_time: '',
            rech_type: '1',
            recharge_dio: false,
            record_dio: false,
            card_re_dio: false,
            re_money: '',
            send_money: '',
            card_money: '',
            index: 0,
            max_ht: 0,
            input: '',
            radio: '',
            checked: '',
            tableData3: [{
                px: '产品',
                class: '面部',
                name: '睡眠面膜',
                price: '231',
                stock: '12',
                fre: '',
                fee: '',
                give: '是'
            }, {
                px: '套盒',
                class: '身体',
                name: '肩颈套',
                price: '2310',
                stock: '12',
                fre: '12',
                fee: '5',
                give: '是'
            }],
            multipleSelection: [],
            list: [],
            r: '',
            fileList: [],
            zt: true,
            need: [],
            user_id: 0,
            tabIndex: 0,
            card: [],
            wear: [],
            need2: [],
            user: '',
            yf: [],
            need3: [],
            nowData: '',
            p: null,
            record: '',
            acc_blance: '',
            card_lis: '',
            ca_id: '',
            card_blance: '',
            cp_list: [],
            xm_list: [],
            th_list: [],
            fa_list: [],
        },
        watch: {
            /*input(v){
                    this.get_search()
            }*/
        },
        methods: {
            pages_fun() {
                this.list = [];
                let m;
                if (this.total < this.page * 10) {
                    m = this.total
                } else {
                    m = this.page * 10
                }
                for (var i = (this.page - 1) * 10; i < m; i++) {
                    this.list.push(this.all_list[i])
                }
            },
            get_search() {
                this.page = 1;
                if (this.tabIndex == 0) {
                    this.search_list = this.cp_list
                } else if (this.tabIndex == 1) {
                    this.search_list = this.xm_list
                } else if (this.tabIndex == 2) {
                    this.search_list = this.th_list
                } else if (this.tabIndex == 3) {
                    this.search_list = this.fa_list
                } else if (this.tabIndex == 4) {
                    this.search_list = this.card
                } else if (this.tabIndex == 5) {
                    this.search_list = this.yf
                }
                if (this.input != '') {
                    this.list = [];
                    this.all_list = [];
                    if (this.tabIndex == 0 || this.tabIndex == 1 || this.tabIndex == 2 || this.tabIndex == 3) {
                        for (let v of this.search_list) {
                            if (v.name != null && v.name.indexOf(this.input) != -1) {
                                this.all_list.push(v);
                            }
                        }
                    } else if (this.tabIndex == 4) {
                        for (let v of this.search_list) {
                            if (v.card_name != null && v.card_name.indexOf(this.input) != -1) {
                                this.all_list.push(v);
                            }
                        }
                    } else if (this.tabIndex == 5) {
                        for (let v of this.search_list) {
                            if ((v.name != null && v.name.indexOf(this.input) != -1) || (v.sn != null && v.sn.indexOf(this.input) != -1) || (v.size != null && v.size.toLowerCase() == this.input.toLowerCase()) || (v.cup != null && v.cup.toLowerCase() == this.input.toLowerCase())) {
                                this.all_list.push(v);
                            }
                        }
                    }
                    this.total = this.all_list.length;
                    if (this.total > 11) {
                        this.pages_fun()
                    } else {
                        this.list = this.all_list
                    }
                } else {
                    if (this.tabIndex == 0) {
                        this.all_list = this.cp_list
                    } else if (this.tabIndex == 1) {
                        this.all_list = this.xm_list
                    } else if (this.tabIndex == 2) {
                        this.all_list = this.th_list
                    } else if (this.tabIndex == 3) {
                        this.all_list = this.fa_list
                    } else if (this.tabIndex == 4) {
                        this.all_list = this.card
                    } else if (this.tabIndex == 5) {
                        this.all_list = this.yf
                    }
                    this.list = [];
                    this.total = this.all_list.length;
                    if (this.total > 11) {
                        this.pages_fun()
                    } else {
                        this.list = this.all_list
                    }
                }
            },
            handleCurrentChange(val) {
                this.page = val;
                this.pages_fun()
            },
            next_click(val) {
                if (val < this.page_count) {
                    this.page++;
                    this.pages_fun()
                }
            },
            prev_click(val) {
                if (val < 2) {
                    this.page--;
                    this.pages_fun()
                }
            },
            bulu_state(state) {
                if (state == false) {
                    this.supp_time = '';
                }
            },
            sub_o_time() {
                /*console.log(this.supp_time)
                $.post(url(methods.change_time),{time:this.supp_time,oid:this.id},v=>{
                    if(v.code == 1){
                        success('订单时间修改成功')
                    }
                })*/
            },
            get_m_blance() {
                $.get(url(methods.member_amount), {mid: this.user_id}, v => {
                    this.acc_blance = v.res;
                })
            },
            get_m_card() {
                $.get(url(methods.recharge_cardList), {id: this.user_id, type: 'list'}, v => {
                    this.card_lis = v.res
                })
            },
            recha_blance() {
                if (this.re_money == '' && this.send_money == '') {
                    error("至少充值一项")
                } else {
                    $.post(url(methods.recharge_account) + `&id=${this.user_id}`, {
                        money: this.re_money,
                        send: this.send_money,
                        time: this.supp_time,
                        integral: this.integral,
                        type: this.ways
                    }, v => {
                        if (v.code == 1) {
                            console.log(v)
                            success(v.Msg)
                            this.re_money = ''
                            this.send_money = '';
                            this.get_m_blance()
                            localStorage.setItem('orderId', v.res.oid)
                            localStorage.setItem('cost', v.res.res)
                            setTimeout(() => location.href = './commission.html', 1000)
                        }
                    })
                }
            },
            card_recha() {
                if (this.card_money == '') {
                    error("请输入要充值的金额")
                } else {
                    $.post(url(methods.save_card) + `&id=${this.ca_id}`, {
                        money: this.card_money,
                        mid: this.user_id,
                        time: this.supp_time,
                        integral: this.integral,
                        type: this.ways
                    }, v => {
                        if (v.code == 1) {
                            success(v.info)
                            this.card_re_dio = false;
                            this.card_money = ''
                            this.get_m_card()
                            console.log(v.res.cost_id)
                            localStorage.setItem('orderId', v.res.oid)
                            localStorage.setItem('cost', v.res.cost_id)
                            setTimeout(() => location.href = './commission.html', 1000)
                        }
                    })
                }
            },
            cancel() {
                this.recharge_dio = false;
                this.record_dio = false;
                this.re_money = ''
                this.send_money = ''
            },
            cancel_in() {
                this.card_re_dio = false;
                this.card_money = ''
            },
            get_record(type) {
                $.post(url(methods.recharge_record), {mid: this.user_id, type: type}, v => {
                    this.record = v.record;
                })
            },
            getPrice(v) {
                v.one = parseFloat(v.price2) / parseFloat(v.needNum)
                v.bf = v.price2
            },
            getDis(v) {
                if (v.bf == null) {
                    if(v.discount==''){
                        v.price2 = parseFloat(v.price) * parseFloat(v.needNum)
                        v.one = v.price
                    }else{
                        v.price2 = parseFloat(v.price) * parseFloat(v.needNum) * parseFloat(v.discount) / 10
                        v.one = parseFloat(v.price2) / parseInt(v.needNum)
                    }
                } else {
                    v.price2 = parseFloat(v.bf) * parseFloat(v.discount) / 10
                    v.one = parseFloat(v.price2) / parseInt(v.needNum)
                }

            },
            height() {
                var height = window.innerHeight;
                if (this.need.length > 0) {
                    this.max_ht = window.innerHeight - 500;
                } else {
                    this.max_ht = window.innerHeight - 172;
                }
            },
            sub() {
                let goods = []
                let url_v;
                if (this.tabIndex == 0) {
                    url_v = url(methods.buyGoods) + `&id=${this.user_id}`;//产品
                    for (let v of this.need) {
                        if (v.yh == 2) {
                            v.price2 = 0;
                        }
                        goods.push({
                            'price': v.price2,
                            [`p_dis_t${v.id}`]: v.discount,
                            'id': v.id,
                            'name': v.name,
                            'sum': v.needNum,
                            'spec': v.spec
                        })
                    }
                } else if (this.tabIndex == 1) {
                    url_v = url(methods.buyItems) + `&id=${this.user_id}`;
                    for (let v of this.need) {
                        if (v.yh == 2) {
                            goods.push({
                                'price': 0,
                                [`p_dis_t${v.id}`]: v.discount,
                                'id': v.id,
                                'name': v.name,
                                'sum': v.needNum,
                                'times': v.fre,
                                'is_rate': v.yh
                            })
                        } else {
                            goods.push({
                                'price': v.price2,
                                [`p_dis_t${v.id}`]: v.discount,
                                'id': v.id,
                                'name': v.name,
                                'sum': v.needNum,
                                'times': v.fre
                            })
                        }
                    }
                } else if (this.tabIndex == 2) {
                    url_v = url(methods.buyTh) + `&id=${this.user_id}`;
                    for (let v of this.need) {
                        if (v.yh == 2) {
                            goods.push({
                                'price': 0,
                                [`p_dis_t${v.id}`]: v.discount,
                                'id': v.id,
                                'name': v.name,
                                'sum': v.needNum,
                                'times': v.fre,
                                'is_rate': v.yh
                            })
                        } else {
                            goods.push({
                                'price': v.price2,
                                [`p_dis_t${v.id}`]: v.discount,
                                'id': v.id,
                                'name': v.name,
                                'sum': v.needNum,
                                'times': v.fre
                            })
                        }
                    }
                } else if (this.tabIndex == 3) {
                    url_v = url(methods.buyPlan) + `&id=${this.user_id}`;
                    for (let v of this.need) {
                        if (v.yh == 2) {
                            v.price2 = 0;
                        }
                        goods.push({
                            'price': v.price2,
                            [`p_dis_t${v.id}`]: v.discount,
                            'id': v.id,
                            'sum': v.needNum,
                        })
                    }
                } else if (this.tabIndex == 4) {
                    url_v = url(methods.buyCard) + `&id=${this.user_id}`;
                    for (let v of this.need) {
                        if (v.yh == 0 || v.yh == 3) {
                            goods.push({'price': v.price2, 'id': v.id, 'sum': v.needNum})
                        } else {
                            goods.push({
                                'price': v.yh == 1 ? v.price * v.dis / 10 : 0,
                                [`p_dis_t${v.id}`]: v.yh,
                                'id': v.id,
                                'sum': v.needNum
                            })
                        }
                    }
                } else if (this.tabIndex == 5) {
                    url_v = url(methods.buyWear) + `&id=${this.user_id}`;
                    for (let v of this.need) {
                        goods.push({
                            'price': v.price2, [`p_dis_t${v.id}`]: v.yh,
                            'id': v.id, 'name': v.name, 'type': v.type, 'spec': v.sum, 'sum': v.needNum
                        })
                    }
                }
                if (this.total_price == 0) {
                    this.$confirm('确定赠送?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        $.post(url_v, {
                            data: JSON.stringify(goods), type: 2
                        }, v => {
                            if (v.code == 1) {
                                this.need = []
                                for (let v of this.list) {
                                    v.needNum = 0;
                                }
                                success('赠送成功')
                                setTimeout(() => location.href = './customer.html', 1000)
                            } else {
                                error(v.error)
                            }
                        })
                    }).catch(e => {

                    })
                } else if (this.total_price > 0) {
                    $.post(url_v, {
                        data: JSON.stringify(goods), type: 1
                    }, v => {
                        if (v.code == 1) {
                            this.need = []
                            for (let v of this.list) {
                                v.needNum = 0;
                            }
                            success(v.Msg)
                            localStorage.setItem('orderId', v.res.orderId)
                            localStorage.setItem('arrearsRes', v.res.arrearsRes)
                            localStorage.setItem('type', 1)
                            setTimeout(() => location.href = './pay_page.html', 1000)
                        } else {
                            error(v.error)
                        }
                    })
                }
            },
            allRemove() {
                this.$confirm('是否全部清空?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.need = []
                    for (let v of this.list) {
                        v.needNum = 0;
                        v.price2 = v.price
                        v.yh = 0
                    }
                }).catch(e => {

                })
                this.height();
            },
            remove(v) {
                if (v.needNum > 0) {
                    v.needNum--
                    v.price2 = parseFloat(v.price2) - parseFloat(v.one)
                    for (let i in this.need) {
                        if (v.id == this.need[i].id && this.need[i].needNum > 0) {
                            z = false
                            break
                        }
                        if (this.need[i].needNum == 0) {
                            this.need[i].needNum = 0
                            this.need[i].price2 = this.need[i].price
                            this.need[i].yh = 0
                            this.need[i].bf = null
                            this.need.splice(i, 1)
                        }
                    }
                }
                this.height();
            },
            add(v) {
                v.needNum++
                let z = true;
                for (let x of this.need) {
                    if (v.id == x.id) {
                        x.price2 = (parseFloat(x.price2) + parseFloat(x.one)).toFixed(2)
                        z = false
                        break
                    }
                }
                if (z) {
                    this.need.unshift(v)
                }
                console.log(this.need)
                this.height();
            },
            getGoods() {
                $.post(url(methods.getAllGoods), v => {
                    let rs = verify(v)
                    if (rs != false) {
                        this.page = 1;
                        this.cp_list = [];
                        this.xm_list = [];
                        this.th_list = [];
                        this.fa_list = [];
                        for (let v of rs) {
                            v['needNum'] = 0
                            v['discount'] = 10
                            v['yh'] = 0
                            v['price2'] = v.price
                            v.one = v.price
                            v.bf = null
                            if (v.type == '产品') {
                                this.cp_list.push(v)
                            } else if (v.type == '项目') {
                                this.xm_list.push(v)
                            } else if (v.type == '套盒') {
                                this.th_list.push(v)
                            } else if (v.type == '方案') {
                                this.fa_list.push(v)
                            }
                        }
                        this.search_list = this.cp_list
                        this.all_list = this.cp_list
                        this.total = this.all_list.length
                        if (this.total <= 10) {
                            this.list = this.all_list
                        } else {
                            this.list = [];
                            this.pages_fun()
                        }
                        // this.list = rs
                    }
                })
            },
            ok() {
                success('上传成功')
                this.fileList = []
                this.getGoods()
            },
            handleClick(tab, event) {
                this.page = 1;
                this.input = '';
                this.tabIndex = tab.index
                this.height();
                if (tab.index == 0) {
                    this.search_list = this.cp_list
                    this.all_list = this.cp_list
                } else if (tab.index == 1) {
                    this.search_list = this.xm_list
                    this.all_list = this.xm_list
                } else if (tab.index == 2) {
                    this.search_list = this.th_list
                    this.all_list = this.th_list
                } else if (tab.index == 3) {
                    this.search_list = this.fa_list
                    this.all_list = this.fa_list
                } else if (tab.index == 4) {
                    this.getCard()
                } else if (tab.index == 5) {
                    this.getYf()
                }
                if (tab.index != 6) {
                    this.total = this.all_list.length
                    if (this.total <= 10) {
                        this.list = this.all_list
                    } else {
                        this.list = [];
                        this.pages_fun()
                    }
                    this.need = []
                    for (let v of this.list) {
                        v.needNum = 0;
                    }
                    this.total_price = 0
                }
            },
            getCard() {
                this.page = 1;
                $.post(url(methods.getCardList), v => {
                    if (v.code == 1) {
                        for (let x of v.card.list) {
                            x.discount = 10
                            x.yh = 0
                            x.needNum = 0
                            x.price2 = x.price
                            x.one = x.price
                            v.bf = null
                        }
                        this.card = v.card.list
                        this.total = v.card.list.length;
                        this.search_list = v.card.list;
                        this.all_list = v.card.list;
                        this.list = [];
                        if (this.total <= 10) {
                            this.list = this.search_list
                        } else {
                            this.list = [];
                            this.pages_fun()
                        }
                    } else {
                        error(v.error)
                    }
                })
            },
            getYf() {
                $.get(url(methods.getUnderwear), v => {
                    for (let x of v.res) {
                        x['type'] = x['type'].toString()
                        x['needNum'] = 0
                        x['discount'] = 10
                        x['yh'] = 0
                        x['price2'] = x.price
                        x['one'] = x.price
                        v.bf = null
                    }
                    this.yf = v.res
                    this.total = v.res.length;
                    this.search_list = v.res;
                    this.all_list = v.res;
                    this.list = [];
                    if (this.total <= 10) {
                        this.list = this.search_list
                    } else {
                        this.list = [];
                        this.pages_fun()
                    }
                })
            },
        },
        computed: {
            total_price() {
                let all = 0
                for (let v of this.need) {
                    console.log(v.yh)
                    if (v.yh != 2) {
                        if(v.yh==1&&v.discount==null){
                           v.one=v.price;
                           console.log(v.one)
                                }
                        all += parseFloat(v.one) * parseInt(v.needNum)
                    }
                }
                return all
            },
        },
        mounted() {
            this.$nextTick(e => {
                //初始化
                that = this;
                this.user_id = localStorage.getItem('user_id')
                this.user = JSON.parse(localStorage.getItem('user'))
                // this.getYf()
                this.getGoods()
                // this.getCard()
                loginState()
                this.height()

            })
        }
    })
</script>